<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Session Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 20px;
            font-size: 2em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.2em;
            color: #4CAF50;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .raw-events {
            height: 200px;
            overflow-y: auto;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #555;
            resize: vertical;
        }

        .event-line {
            color: #64B5F6;
            margin: 0;
            font-size: 0.9em;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .pipeline-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .pipeline {
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
        }

        .pipeline-title {
            font-size: 1.3em;
            color: #2196F3;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 8px;
        }

        .model1-title {
            color: #FF9800;
            border-bottom-color: #FF9800;
        }

        .subsection {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 12px;
            min-height: 80px;
            resize: vertical;
            overflow: auto;
        }

        .subsection-title {
            font-size: 0.95em;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .xml-content {
            color: #64B5F6;
            font-size: 0.85em;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .thinking-content {
            color: #FFB74D;
            font-size: 0.85em;
            line-height: 1.4;
            font-style: italic;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .answer {
            font-size: 1.1em;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .answer.new {
            background: #2E7D32;
            color: #fff;
        }

        .answer.existing {
            background: #1565C0;
            color: #fff;
        }

        .group-badge {
            display: inline-block;
            background: #555;
            color: #fff;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-right: 5px;
        }

        .neighbor-item {
            background: #2a2a2a;
            padding: 6px 10px;
            margin: 4px 0;
            border-left: 3px solid #FF9800;
            border-radius: 2px;
            font-size: 0.85em;
        }

        .summary-output {
            color: #81C784;
            font-size: 0.95em;
            padding: 10px;
            background: #1a3a1a;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        .status {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.9em;
            color: #FFB74D;
        }

        .processing {
            color: #FFB74D;
            animation: pulse 1.5s infinite;
        }

        .error-status {
            color: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .empty-state {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Terminal Session Visualizer</h1>

        <!-- Raw Events Stream -->
        <div class="section">
            <div class="section-title">Raw XML Events Stream</div>
            <div class="raw-events" id="rawEvents">
                <div class="empty-state">Waiting for events...</div>
            </div>
        </div>

        <!-- Pipeline Container -->
        <div class="pipeline-container">
            <!-- Model 0 Pipeline -->
            <div class="pipeline">
                <div class="pipeline-title">MODEL 0</div>

                <!-- Model 0 Input -->
                <div class="subsection" style="height: 300px;">
                    <div class="subsection-title">Model 0 Input Context</div>
                    <div id="model0Input" class="xml-content" style="height: calc(100% - 30px); overflow-y: auto;">
                        <div class="empty-state">Waiting for input...</div>
                    </div>
                </div>

                <!-- Model 0 Response -->
                <div class="subsection" style="height: 300px;">
                    <div class="subsection-title">Model 0 Full Response</div>
                    <div id="model0Thinking" class="thinking-content" style="height: calc(100% - 30px); overflow-y: auto;">
                        <div class="empty-state">Waiting for response...</div>
                    </div>
                </div>

                <!-- Model 0 Answer -->
                <div class="subsection" style="resize: none;">
                    <div class="subsection-title">Model 0 Answer</div>
                    <div id="model0Answer">
                        <div class="empty-state">Waiting for answer...</div>
                    </div>
                </div>
            </div>

            <!-- Model 1 Pipeline -->
            <div class="pipeline">
                <div class="pipeline-title model1-title">
                    MODEL 1
                    <span class="status" id="model1Status" style="display: none;"></span>
                </div>

                <!-- Previous Summaries (Neighbors) -->
                <div class="subsection" style="height: 100px;">
                    <div class="subsection-title">Previous Summaries (Neighbors)</div>
                    <div id="neighbors" style="height: calc(100% - 30px); overflow-y: auto;">
                        <div class="empty-state">No summaries yet...</div>
                    </div>
                </div>

                <!-- Current HLC Group to Process -->
                <div class="subsection" style="height: 150px;">
                    <div class="subsection-title">Current HLC Group to Process</div>
                    <div id="model1Input" class="xml-content" style="height: calc(100% - 30px); overflow-y: auto;">
                        <div class="empty-state">Waiting for completed group...</div>
                    </div>
                </div>

                <!-- Model 1 Summary -->
                <div class="subsection" style="resize: none;">
                    <div class="subsection-title">Model 1 Summary</div>
                    <div id="model1Summary">
                        <div class="empty-state">Waiting for summary...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Group Building Section -->
        <div class="section">
            <div class="section-title">Current Group Being Built</div>
            <div class="subsection" style="height: 150px;">
                <div id="currentGroup" class="xml-content" style="height: 100%; overflow-y: auto;">
                    <div class="empty-state">No group yet...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const ws = new WebSocket(`ws://${window.location.host}/ws`);

        // State
        let neighbors = [];
        let currentGroupEvents = [];

        // DOM elements
        const rawEvents = document.getElementById('rawEvents');
        const currentGroup = document.getElementById('currentGroup');
        const model0Input = document.getElementById('model0Input');
        const model0Thinking = document.getElementById('model0Thinking');
        const model0Answer = document.getElementById('model0Answer');
        const neighborsDiv = document.getElementById('neighbors');
        const model1Input = document.getElementById('model1Input');
        const model1Summary = document.getElementById('model1Summary');
        const model1Status = document.getElementById('model1Status');

        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatXml(xml) {
            return escapeHtml(xml).replace(/&lt;/g, '<span style="color: #888">&lt;</span>')
                                    .replace(/&gt;/g, '<span style="color: #888">&gt;</span>');
        }

        function addRawEvent(xml) {
            const line = document.createElement('div');
            line.className = 'event-line';
            line.textContent = xml;
            rawEvents.appendChild(line);
            rawEvents.scrollTop = rawEvents.scrollHeight;

            // Remove empty state
            const emptyState = rawEvents.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
        }

        function updateCurrentGroup(groupId, events) {
            currentGroupEvents = events;
            if (events.length === 0) {
                currentGroup.innerHTML = '<div class="empty-state">No events yet...</div>';
                return;
            }

            let html = `<span class="group-badge">Group ${groupId}</span> <span style="color: #888">(${events.length} event${events.length > 1 ? 's' : ''})</span><br><br>`;
            events.forEach((evt, idx) => {
                html += formatXml(evt) + '<br>';
            });
            currentGroup.innerHTML = html;
        }

        function updateModel0Input(data) {
            let html = '<div style="color: #888; margin-bottom: 8px;">Input context with sortme event:</div>';
            html += formatXml(data.input_xml);
            model0Input.innerHTML = html;
            // Auto-scroll to bottom
            model0Input.scrollTop = model0Input.scrollHeight;
        }

        function updateModel0Thinking(fullResponse) {
            if (!fullResponse) {
                model0Thinking.innerHTML = '<div class="empty-state">No response...</div>';
                return;
            }
            model0Thinking.textContent = fullResponse;
        }

        function updateModel0Answer(answer, groupId) {
            const answerDiv = document.createElement('div');
            answerDiv.className = `answer ${answer.toLowerCase()}`;
            answerDiv.textContent = answer === 'NEW' ? `Answer: NEW (Start Group ${groupId + 1})` : `Answer: ${groupId} (Continue)`;
            model0Answer.innerHTML = '';
            model0Answer.appendChild(answerDiv);
        }

        function addNeighbor(groupId, summary, depth) {
            neighbors.push({id: groupId, summary: summary, depth: depth});

            // Keep only last 20 neighbors (to match backend)
            if (neighbors.length > 20) {
                neighbors = neighbors.slice(-20);
            }

            updateNeighborsDisplay();
        }

        function updateNeighborsDisplay() {
            if (neighbors.length === 0) {
                neighborsDiv.innerHTML = '<div class="empty-state">No summaries yet...</div>';
                return;
            }

            let html = '';
            neighbors.forEach(n => {
                html += `<div class="neighbor-item"><span class="group-badge">${n.id}</span> <span style="color: #FFB74D; font-weight: bold;">depth=${n.depth}</span> ${escapeHtml(n.summary)}</div>`;
            });
            neighborsDiv.innerHTML = html;
            // Auto-scroll to bottom to show latest neighbors
            neighborsDiv.scrollTop = neighborsDiv.scrollHeight;
        }

        function updateModel1Input(data) {
            const {group_id, neighbors: neighborLines, events, current_depth} = data;

            let html = `<span class="group-badge">Group ${group_id}</span> <span style="color: #888">(${events.length} event${events.length > 1 ? 's' : ''})</span>`;
            html += `<span style="color: #FFB74D; margin-left: 10px;">Current Depth: ${current_depth}</span><br><br>`;

            if (neighborLines && neighborLines.length > 0) {
                html += '<div style="color: #888; font-size: 0.85em; margin-bottom: 8px;">Neighbors being sent:</div>';
                neighborLines.forEach(line => {
                    html += `<div style="color: #888; font-size: 0.8em; margin-left: 10px;">${escapeHtml(line)}</div>`;
                });
                html += '<br>';
            }

            html += '<div style="color: #888; margin-bottom: 8px;">Events:</div>';
            events.forEach(evt => {
                html += formatXml(evt) + '<br>';
            });
            model1Input.innerHTML = html;
        }

        function updateModel1Summary(data) {
            const {summary, depth, thinking, json} = data;

            let html = '<div class="summary-output">';
            html += `<strong>Summary:</strong> ${escapeHtml(summary)}<br>`;
            html += `<strong>Depth:</strong> <span style="color: #FFB74D;">${depth}</span>`;
            html += '</div>';

            if (thinking) {
                html += '<div style="margin-top: 10px; padding: 8px; background: #2a2a2a; border-radius: 4px; border-left: 3px solid #FFB74D;">';
                html += '<div style="color: #888; font-size: 0.85em; margin-bottom: 4px;">Model Thinking:</div>';
                html += `<div style="color: #FFB74D; font-size: 0.85em; font-style: italic;">${escapeHtml(thinking)}</div>`;
                html += '</div>';
            }

            model1Summary.innerHTML = html;
        }

        // WebSocket event handlers
        ws.onopen = () => {
            console.log('Connected to server');
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);

            switch(message.type) {
                case 'raw_event':
                    addRawEvent(message.data);
                    break;

                case 'current_group_update':
                    updateCurrentGroup(message.data.group_id, message.data.events);
                    break;

                case 'model0_input':
                    updateModel0Input(message.data);
                    break;

                case 'model0_thinking':
                    updateModel0Thinking(message.data.full_response);
                    break;

                case 'model0_answer':
                    updateModel0Answer(message.data.answer, message.data.group_id);
                    break;

                case 'model1_input':
                    updateModel1Input(message.data);
                    model1Status.innerHTML = '<span class="processing">Processing...</span>';
                    model1Status.style.display = 'inline-block';
                    break;

                case 'model1_summary':
                    updateModel1Summary(message.data);
                    addNeighbor(message.data.group_id, message.data.summary, message.data.depth);
                    // Hide status after summary arrives
                    model1Status.style.display = 'none';
                    break;

                case 'model1_error':
                    model1Status.innerHTML = `<span class="error-status">Error: ${escapeHtml(message.data.error)}</span>`;
                    model1Status.style.display = 'inline-block';
                    break;

                case 'complete':
                    // Hide status when complete
                    model1Status.style.display = 'none';
                    console.log('Pipeline complete');
                    break;

                case 'error':
                    console.error('Error:', message.data);
                    model1Status.innerHTML = `<span class="error-status">Error: ${escapeHtml(message.data)}</span>`;
                    model1Status.style.display = 'inline-block';
                    break;
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
            console.log('Disconnected from server');
            model1Status.innerHTML = '<span class="error-status">Disconnected</span>';
            model1Status.style.display = 'inline-block';
        };
    </script>
</body>
</html>
